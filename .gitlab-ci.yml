image: debian:stretch

services:
  - name: docker.elastic.co/elasticsearch/elasticsearch:6.7.2
    alias: elasticsearch
  - redis:latest

stages:
  - test
#  - build

Test:
  before_script:
    - wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh \
        && sh Miniconda3-latest-Linux-x86_64.sh -b -p /var/miniconda3 \
        && rm Miniconda3-latest-Linux-x86_64.sh
    - python -V
    - pip install -r requirements.txt
    - python import_test_index.py -es http://elasticsearch:9200
    - python migrate.py
  stage: test
  tags:
  - ci-test
  variables:
    TEXTA_ES_URL: http://elasticsearch:9200
    TEXTA_REDIS_URL: redis://redis:6379
  script:
  - python manage.py test

#Build:
#  stage: build
#  tags:
#  - docker
#  script:
#  - docker build -t docker.texta.ee/texta/texta-rest:latest .
#  - docker login -u $CI_DEPLOY_USER -p $CI_DEPLOY_PASSWORD docker.texta.ee
#  - docker push docker.texta.ee/texta/texta-rest:latest